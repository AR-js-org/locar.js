var k=a=>{throw TypeError(a)};var F=(a,t,e)=>t.has(a)||k("Cannot "+e);var o=(a,t,e)=>(F(a,t,"read from private field"),e?e.call(a):t.get(a)),p=(a,t,e)=>t.has(a)?k("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(a):t.set(a,e),u=(a,t,e,i)=>(F(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e),E=(a,t,e)=>(F(a,t,"access private method"),e);var q=(a,t,e,i)=>({set _(s){u(a,t,s,e)},get _(){return o(a,t,i)}});import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as w,c as tt,V as et,d as it,E as nt,e as V,Q as _,P as ot,W as st,S as at,B as rt,M as dt,a as ct}from"./three.module-YNhpf6Xm.js";var D,Q,U,X,Z;class lt{constructor(){p(this,D);this.EARTH=4007501668e-2,this.HALF_EARTH=2003750834e-2}project(t,e){return[E(this,D,Q).call(this,t),E(this,D,U).call(this,e)]}unproject(t){return[E(this,D,X).call(this,t[0]),E(this,D,Z).call(this,t[1])]}getID(){return"epsg:3857"}}D=new WeakSet,Q=function(t){return t/180*this.HALF_EARTH},U=function(t){var e=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return e*this.HALF_EARTH/180},X=function(t){return t/this.HALF_EARTH*180},Z=function(t){var e=t/this.HALF_EARTH*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),e};var x,A,O,H,I,b,M,L,C,P,y,j,Y,$,K;class ht{constructor(t,e,i={},s=null){p(this,y);p(this,x);p(this,A);p(this,O);p(this,H);p(this,I);p(this,b);p(this,M);p(this,L);p(this,C);p(this,P);this.scene=t,this.camera=e,u(this,x,new lt),u(this,A,{}),u(this,O,null),u(this,H,0),u(this,I,100),u(this,b,null),this.setGpsOptions(i),u(this,M,null),u(this,L,0),u(this,C,0),u(this,P,s)}setProjection(t){u(this,x,t)}setGpsOptions(t={}){t.gpsMinDistance!==void 0&&u(this,H,t.gpsMinDistance),t.gpsMinAccuracy!==void 0&&u(this,I,t.gpsMinAccuracy)}async startGps(){if(o(this,P)){const e=await(await o(this,P).sendData("/gps/start",{gpsMinDistance:o(this,H),gpsMinAccuracy:o(this,I)})).json();u(this,C,e.session)}return o(this,b)===null?(u(this,b,navigator.geolocation.watchPosition(t=>{E(this,y,$).call(this,t)},t=>{o(this,A).gpserror?o(this,A).gpserror(t.code):alert(`GPS error: code ${t.code}`)},{enableHighAccuracy:!0})),!0):!1}stopGps(){return o(this,b)!==null?(navigator.geolocation.clearWatch(o(this,b)),u(this,b,null),!0):!1}fakeGps(t,e,i=null,s=0){i!==null&&this.setElevation(i),E(this,y,$).call(this,{coords:{longitude:t,latitude:e,accuracy:s}})}lonLatToWorldCoords(t,e){const i=o(this,x).project(t,e);if(o(this,M))i[0]-=o(this,M)[0],i[1]-=o(this,M)[1];else throw"No initial position determined";return[i[0],-i[1]]}add(t,e,i,s,h={}){var m;t.properties=h,E(this,y,j).call(this,t,e,i,s),this.scene.add(t),(m=o(this,P))==null||m.sendData("/object/new",{position:t.position,x:t.position.x,z:t.position.z,session:o(this,C),properties:h})}setElevation(t){this.camera.position.y=t}on(t,e){o(this,A)[t]=e}}x=new WeakMap,A=new WeakMap,O=new WeakMap,H=new WeakMap,I=new WeakMap,b=new WeakMap,M=new WeakMap,L=new WeakMap,C=new WeakMap,P=new WeakMap,y=new WeakSet,j=function(t,e,i,s){const h=this.lonLatToWorldCoords(e,i);s!==void 0&&(t.position.y=s),[t.position.x,t.position.z]=h},Y=function(t,e){u(this,M,o(this,x).project(t,e))},$=function(t){var i,s,h;let e=Number.MAX_VALUE;q(this,L)._++,(i=o(this,P))==null||i.sendData("/gps/new",{gpsCount:o(this,L),lat:t.coords.latitude,lon:t.coords.longitude,acc:t.coords.accuracy,session:o(this,C)}),t.coords.accuracy<=o(this,I)&&(o(this,O)===null?u(this,O,{latitude:t.coords.latitude,longitude:t.coords.longitude}):e=E(this,y,K).call(this,o(this,O),t.coords),e>=o(this,H)&&(o(this,O).longitude=t.coords.longitude,o(this,O).latitude=t.coords.latitude,o(this,M)||(E(this,y,Y).call(this,t.coords.longitude,t.coords.latitude),(s=o(this,P))==null||s.sendData("/worldorigin/new",{gpsCount:o(this,L),lat:t.coords.latitude,lon:t.coords.longitude,session:o(this,C),initialPosition:o(this,M)})),E(this,y,j).call(this,this.camera,t.coords.longitude,t.coords.latitude),(h=o(this,P))==null||h.sendData("/gps/accepted",{gpsCount:o(this,L),cameraX:this.camera.position.x,cameraZ:this.camera.position.z,session:o(this,C),distMoved:e}),o(this,A).gpsupdate&&o(this,A).gpsupdate(t,e)))},K=function(t,e){const i=w.degToRad(e.longitude-t.longitude),s=w.degToRad(e.latitude-t.latitude),h=Math.sin(s/2)*Math.sin(s/2)+Math.cos(w.degToRad(t.latitude))*Math.cos(w.degToRad(e.latitude))*(Math.sin(i/2)*Math.sin(i/2));return 2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h))*6371e3};class ut{constructor(t,e,i){this.renderer=t,this.initCamera(e,i),console.log("hello")}async initCamera(t,e){console.log("initCamera()");let i;t?i=document.querySelector(t):(i=document.createElement("video"),i.setAttribute("autoplay",!0),i.setAttribute("playsinline",!0),i.style.display="none",document.body.appendChild(i));const s=screen.availHeight>screen.availWidth;this.geom=new tt,this.texture=new et(i),console.log(this.renderer);const h=this.renderer.domElement.width,m=this.renderer.domElement.height,f=h/m;let n=s?-.5:-.5*f,d=s?.5:.5*f,c=s?.5/f:.5,r=s?-.5/f:-.5;if(n=-f/2,d=f/2,c=.5,r=-.5,console.log(`CANVAS W/H ${h} ${m} ASPECT ${f} left ${n} right ${d} top ${c} bottom ${r}`),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){let l=window.innerWidth,T=window.innerHeight;l=s?600:800,T=s?800:600;const v={video:{width:{ideal:l},height:{ideal:T},facingMode:"environment"}};try{const g=await navigator.mediaDevices.getUserMedia(v);console.log("using the webcam successfully..."),i.addEventListener("loadedmetadata",()=>{console.log(`Video loaded w ${i.videoWidth} h ${i.videoHeight}`),i.setAttribute("width",i.videoWidth),i.setAttribute("height",i.videoHeight),i.play(),e.onVideoStarted(this.texture)}),i.srcObject=g}catch(g){setTimeout(()=>{alert(`Webcam Error
Name: `+g.name+`
Message: `+g.message)},1e3)}}else setTimeout(()=>{alert("sorry - media devices API not supported")},1e3)}update(){this.renderer.clear(),this.renderer.render(this.sceneWebcam,this.cameraWebcam),this.renderer.clearDepth()}dispose(){this.material.dispose(),this.texture.dispose(),this.geom.dispose()}}const z=navigator.userAgent.match(/iPhone|iPad|iPod/i)||/Macintosh/i.test(navigator.userAgent)&&navigator.maxTouchPoints!=null&&navigator.maxTouchPoints>1,gt=new it(0,0,1),N=new V,mt=new _,ft=new _(-Math.sqrt(.5),0,0,Math.sqrt(.5)),pt={type:"change"};class vt extends nt{constructor(t){super(),window.isSecureContext===!1&&console.error("THREE.DeviceOrientationControls: DeviceOrientationEvent is only available in secure contexts (https)");const e=this,i=1e-6,s=new _;this.object=t,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation=null,this.screenOrientation=0,this.alphaOffset=0,this.initialOffset=null,this.TWO_PI=2*Math.PI,this.HALF_PI=.5*Math.PI,this.orientationChangeEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation",this.smoothingFactor=1;const h=function({alpha:n,beta:d,gamma:c,webkitCompassHeading:r}){if(z){const l=360-r;e.alphaOffset=w.degToRad(l-n),e.deviceOrientation={alpha:n,beta:d,gamma:c,webkitCompassHeading:r}}else n<0&&(n+=360),e.deviceOrientation={alpha:n,beta:d,gamma:c};window.dispatchEvent(new CustomEvent("camera-rotation-change",{detail:{cameraRotation:t.rotation}}))},m=function(){e.screenOrientation=window.orientation||0},f=function(n,d,c,r,l){N.set(c,d,-r,"YXZ"),n.setFromEuler(N),n.multiply(ft),n.multiply(mt.setFromAxisAngle(gt,-l))};this.connect=function(){m(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(n=>{n==="granted"&&(window.addEventListener("orientationchange",m),window.addEventListener(e.orientationChangeEventName,h))}).catch(function(n){console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",n)}):(window.addEventListener("orientationchange",m),window.addEventListener(e.orientationChangeEventName,h)),e.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",m),window.removeEventListener(e.orientationChangeEventName,h),e.enabled=!1,e.initialOffset=!1,e.deviceOrientation=null},this.update=function({theta:n=0}={theta:0}){if(e.enabled===!1)return;const d=e.deviceOrientation;if(d){let c=d.alpha?w.degToRad(d.alpha)+e.alphaOffset:0,r=d.beta?w.degToRad(d.beta):0,l=d.gamma?w.degToRad(d.gamma):0;const T=e.screenOrientation?w.degToRad(e.screenOrientation):0;if(z){const v=new _;f(v,c,r,l,T);const g=new V().setFromQuaternion(v,"YXZ");console.log(g.x,g.y,g.z),g.y=w.degToRad(360-d.webkitCompassHeading),v.setFromEuler(g),e.object.quaternion.copy(v)}else{if(this.smoothingFactor<1){if(this.lastOrientation){const v=this.smoothingFactor;c=this._getSmoothedAngle(c,this.lastOrientation.alpha,v),r=this._getSmoothedAngle(r+Math.PI,this.lastOrientation.beta,v),l=this._getSmoothedAngle(l+this.HALF_PI,this.lastOrientation.gamma,v,Math.PI)}else r+=Math.PI,l+=this.HALF_PI;this.lastOrientation={alpha:c,beta:r,gamma:l}}f(e.object.quaternion,c+n,this.smoothingFactor<1?r-Math.PI:r,this.smoothingFactor<1?l-this.HALF_PI:l,T)}8*(1-s.dot(e.object.quaternion))>i&&(s.copy(e.object.quaternion),e.dispatchEvent(pt))}},this._orderAngle=function(n,d,c=this.TWO_PI){return d>n&&Math.abs(d-n)<c/2||n>d&&Math.abs(d-n)>c/2?{left:n,right:d}:{left:d,right:n}},this._getSmoothedAngle=function(n,d,c,r=this.TWO_PI){const l=this._orderAngle(n,d,r),T=l.left,v=l.right;l.left=0,l.right-=T,l.right<0&&(l.right+=r);let g=v==d?(1-c)*l.right+c*l.left:c*l.right+(1-c)*l.left;return g+=T,g>=r&&(g-=r),g},this.updateAlphaOffset=function(){e.initialOffset=!1},this.dispose=function(){e.disconnect()},this.getAlpha=function(){const{deviceOrientation:n}=e;return n&&n.alpha?w.degToRad(n.alpha)+e.alphaOffset:0},this.getBeta=function(){const{deviceOrientation:n}=e;return n&&n.beta?w.degToRad(n.beta):0},window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?this.initPermissionDialog():this.connect()}initPermissionDialog(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div");document.body.appendChild(t);const h={display:"flex",position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:1,backgroundColor:"rgba(0,0,0,0.6)",justifyContent:"center",alignItems:"center"},m={backgroundColor:"white",padding:"6px",borderRadius:"3px",width:"36rem",height:"24rem"},f={width:"100%",height:"70%",display:"flex",justifyContent:"center",alignItems:"center"},n={display:"inline-flex",width:"100%",height:"30%",justifyContent:"center",alignItems:"center"};for(let r in h)t.style[r]=h[r];for(let r in m)e.style[r]=m[r];for(let r in f)i.style[r]=f[r];for(let r in n)s.style[r]=n[r];t.appendChild(e),e.appendChild(i),e.appendChild(s),i.innerHTML='<div style="font-size: 24pt; margin: 1rem;">This immersive website requires access to your device motion sensors.</div>';const d=()=>{this.connect(),t.style.display="none"},c=document.createElement("button");c.addEventListener("click",d),c.style.width="50%",c.style.height="80%",c.style.fontSize="20pt",c.appendChild(document.createTextNode("OK")),s.appendChild(c),document.body.appendChild(t)}}const S=new ot(80,window.innerWidth/window.innerHeight,.001,1e3),R=new st;R.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(R.domElement);const J=new at,W=new ht(J,S);window.addEventListener("resize",a=>{R.setSize(window.innerWidth,window.innerHeight),S.aspect=window.innerWidth/window.innerHeight,S.updateProjectionMatrix()});const wt=new ut(R);let B=!0,G=new vt(S);W.on("gpsupdate",(a,t)=>{if(B){alert(`Got the initial location: longitude ${a.coords.longitude}, latitude ${a.coords.latitude}`);const e=[{latDis:5e-4,lonDis:0,colour:16711680},{latDis:-5e-4,lonDis:0,colour:16776960},{latDis:0,lonDis:-5e-4,colour:65535},{latDis:0,lonDis:5e-4,colour:65280}],i=new rt(10,10,10);for(const s of e){const h=new dt(i,new ct({color:s.colour}));console.log(`adding at ${a.coords.longitude+s.lonDis},${a.coords.latitude+s.latDis}`),W.add(h,a.coords.longitude+s.lonDis,a.coords.latitude+s.latDis)}B=!1}});W.startGps();document.getElementById("setFakeLoc").addEventListener("click",a=>{alert("Using fake input GPS, not real GPS location"),W.stopGps(),W.fakeGps(parseFloat(document.getElementById("fakeLon").value),parseFloat(document.getElementById("fakeLat").value))});R.setAnimationLoop(yt);function yt(){wt.update(),G==null||G.update(),R.render(J,S)}
